# ─── NGINX Reverse Proxy (Local API Gateway) ────────────────────
# Routes frontend API calls to the correct backend microservice.
# Replaces AWS API Gateway for local development.
#
# All services share the /api/v1/ prefix.
# Routing is based on the second path segment:
#   /api/v1/auth/*          → user-service:8081
#   /api/v1/users/*         → user-service:8081
#   /api/v1/jobs/*          → job-service:8082
#   /api/v1/applications/*  → application-service:8083
#   /api/v1/notifications/* → notification-service:8084
#   /api/v1/analytics/*     → analytics-service:8085
#   /actuator/*             → pass-through per service

# Use Docker's embedded DNS resolver so NGINX resolves at request time,
# not at startup.  This prevents crashes when backends aren't ready yet.
resolver 127.0.0.11 valid=10s ipv6=off;

server {
    listen 8080;
    server_name localhost;

    # ─── Security headers ────────────────────────────────────
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options DENY;

    # ─── CORS (allow React dev server) ───────────────────────
    # Prevent duplicate CORS headers from upstream services by hiding
    # any Access-Control-* headers returned by the backend, then add
    # a single set of CORS headers here.
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Methods;
    proxy_hide_header Access-Control-Allow-Headers;
    proxy_hide_header Access-Control-Allow-Credentials;

    add_header Access-Control-Allow-Origin  "http://localhost:3000" always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-CSRF-Token, X-User-Id" always;
    add_header Access-Control-Allow-Credentials "true" always;

    # Preflight
    if ($request_method = OPTIONS) {
        return 204;
    }

    # ─── Auth routes → user-service ──────────────────────────
    location /api/v1/auth/ {
        set $upstream_user http://user-service:8081;
        proxy_pass $upstream_user;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 10s;
        proxy_read_timeout 30s;
    }

    # ─── User routes → user-service ──────────────────────────
    location /api/v1/users/ {
        set $upstream_user http://user-service:8081;
        proxy_pass $upstream_user;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 10s;
        proxy_read_timeout 30s;
    }

    # ─── Job routes → job-service ────────────────────────────
    location /api/v1/jobs/ {
        set $upstream_job http://job-service:8082;
        proxy_pass $upstream_job;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 10s;
        proxy_read_timeout 30s;
    }

    # ─── Application routes → application-service ────────────
    location /api/v1/applications/ {
        set $upstream_app http://application-service:8083;
        proxy_pass $upstream_app;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 10s;
        proxy_read_timeout 30s;
    }

    # ─── Notification routes → notification-service ──────────
    location /api/v1/notifications/ {
        set $upstream_notif http://notification-service:8084;
        proxy_pass $upstream_notif;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 10s;
        proxy_read_timeout 30s;
    }

    # ─── Analytics / Metrics routes → analytics-service ──────
    location /api/v1/analytics/ {
        set $upstream_analytics http://analytics-service:8085;
        proxy_pass $upstream_analytics;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 10s;
        proxy_read_timeout 30s;
    }

    # ─── Web Vitals beacon endpoint → analytics-service ──────
    location /api/v1/metrics/ {
        set $upstream_analytics http://analytics-service:8085;
        proxy_pass $upstream_analytics;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ─── Health check ────────────────────────────────────────
    location /health {
        return 200 '{"status":"UP","gateway":"nginx"}';
        add_header Content-Type application/json;
    }

    # ─── Default → 404 ───────────────────────────────────────
    location / {
        return 404 '{"error":"Route not found","message":"No backend service matches this path"}';
        add_header Content-Type application/json;
    }
}
